name: Terraform Infra Pipeline

on:
  workflow_dispatch:     # Manual trigger
  pull_request:          # Runs plan on PR to main
    branches:
      - main
  issue_comment:         # /apply comment
    types: [created]

permissions:
  contents: read
  pull-requests: write
  id-token: write

jobs:
  ############################################
  # PLAN JOB ‚Äì Runs on PR or manual trigger
  ############################################
  terraform:
    if: |
      github.event_name == 'workflow_dispatch' ||
      github.event_name == 'pull_request'
    runs-on: ubuntu-latest

    env:
      AWS_REGION: ap-south-2
      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}

    steps:
      - uses: actions/checkout@v4

      - uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.9.5

      - name: Terraform Init
        working-directory: ./terraform-infra
        run: terraform init

      - name: Terraform Validate
        working-directory: ./terraform-infra
        run: terraform validate

      - name: Checkov Security Scan
        uses: bridgecrewio/checkov-action@master
        with:
          quiet: true
          directory: ./terraform-infra
        continue-on-error: true

      - name: Install Sentinel CLI
        run: |
          set -e
          SENT_VER="0.29.0"

          # Delete old binary to avoid unzip prompts
            rm -f sentinel

          wget -q https://releases.hashicorp.com/sentinel/${SENT_VER}/sentinel_${SENT_VER}_linux_amd64.zip
          unzip -o sentinel_${SENT_VER}_linux_amd64.zip
          chmod +x sentinel
          sudo mv sentinel /usr/local/bin/
          rm -f sentinel_${SENT_VER}_linux_amd64.zip

          sentinel version

      - name: Terraform Plan
        working-directory: ./terraform-infra
        run: |
          terraform plan -no-color -out=tfplan | tee plan.log
          terraform show -json tfplan > tfplan.json

      - name: Upload plan
        uses: actions/upload-artifact@v4
        with:
          name: terraform-plan
          path: terraform-infra/tfplan

      - name: Post Plan Result to PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const plan = fs.readFileSync('terraform-infra/plan.log', 'utf8').slice(0, 65000);

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: `üõ†Ô∏è **Terraform Plan Output**\n\`\`\`\n${plan}\n\`\`\`\nüí¨ Comment **/apply** to deploy after approval.`
            });

  ############################################
  # APPLY JOB ‚Äì Triggered by "/apply" comment
  # AND requires environment approval
  ############################################
  apply:
    needs: terraform
    runs-on: ubuntu-latest
    environment:
      name: production
      url: https://example.com        # optional

    if: |
      github.event_name == 'issue_comment' &&
      github.event.issue.pull_request != null &&
      startsWith(github.event.comment.body, '/apply')

    env:
      AWS_REGION: ap-south-2
      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}

    steps:
      - uses: actions/checkout@v4

      - uses: hashicorp/setup-terraform@v3

      - name: Download Terraform Plan
        uses: actions/download-artifact@v4
        with:
          name: terraform-plan

      - name: Terraform Init
        working-directory: ./terraform-infra
        run: terraform init -input=false

      - name: Terraform Apply
        working-directory: ./terraform-infra
        run: terraform apply -input=false tfplan | tee apply.log

      - name: Post Apply Result
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const apply = fs.readFileSync('terraform-infra/apply.log', 'utf8').slice(0, 65000);

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: `üöÄ **Terraform Apply Completed**\n\`\`\`\n${apply}\n\`\`\`\n‚úÖ Deployment Successful!`
            });
