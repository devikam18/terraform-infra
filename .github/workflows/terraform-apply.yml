name: Terraform-apply.yml

#name: Terraform Automation

on:
  workflow_dispatch:     # Manual trigger

  pull_request:          # Trigger on PRs into main
    branches:
      - main

  issue_comment:         # For /plan and /apply commands
    types: [created]

permissions:
  contents: write
  pull-requests: write
  id-token: write

jobs:

  terraform:
    runs-on: ubuntu-latest

    if: |
      github.event_name == 'push' ||
      (github.event_name == 'issue_comment' &&
       github.event.issue.pull_request != null &&
       (startsWith(github.event.comment.body, '/plan') || startsWith(github.event.comment.body, '/apply')))

    env:
      AWS_REGION: ap-south-2
      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.9.5

      # ğŸ§© Step 1: Auto-create PR on push
      - name: Create Pull Request
        if: github.event_name == 'push'
        id: create_pr
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GH_PAT }}
          branch: test
          base: main
          title: "ğŸª„ Terraform Infrastructure Changes"
          body: "This PR contains automated Terraform plan and apply steps."
          commit-message: "chore: terraform auto update"
          delete-branch: false

      # ğŸ§© Step 2: Detect PR number dynamically
      - name: Find PR number
        id: find_pr
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GH_PAT }}
          script: |
            const event = context.payload;
            let prNumber = null;
            
            if (event.pull_request) {
              prNumber = event.pull_request.number;
            } else if (event.issue && event.issue.pull_request) {
              prNumber = event.issue.number;
            } else {
              const prs = await github.rest.pulls.list({
                owner: context.repo.owner,
                repo: context.repo.repo,
                head: `${context.repo.owner}:${context.ref.replace('refs/heads/', '')}`,
                state: 'open'
              });
              if (prs.data.length > 0) prNumber = prs.data[0].number;
            }

            if (prNumber) {
              core.setOutput("pr_number", prNumber);
              console.log(`âœ… Found PR #${prNumber}`);
            } else {
              console.log("âš ï¸ No PR found for this branch/event.");
            }

      # ğŸ§© Step 3: Terraform Plan
      - name: Terraform Init
        run: terraform init

      - name: Terraform Validate
        run: terraform validate

      - name: Terraform Plan
        run: terraform plan -no-color -out=tfplan | tee plan.log

      # ğŸ§© Step 4: Post Plan Result to PR
      - name: Post Plan Result
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GH_PAT }}
          script: |
            const fs = require('fs');
            const planFile = 'plan.log';
            const prNumber = process.env.PR_NUMBER;

            if (!fs.existsSync(planFile)) {
              console.log("âš ï¸ plan.log not found â€” skipping comment.");
            } else if (!prNumber) {
              console.log("âš ï¸ No PR number found â€” skipping comment.");
            } else {
              const plan = fs.readFileSync(planFile, 'utf8').slice(0, 65000);
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: parseInt(prNumber, 10),
                body: `ğŸª„ **Terraform Plan Result:**\n\`\`\`\n${plan}\n\`\`\`\nğŸ’¬ Comment **/apply** to trigger deployment.`
              });
            }
        env:
          PR_NUMBER: ${{ steps.find_pr.outputs.pr_number }}

      # ğŸ§© Step 5: Terraform Apply (manual or auto)
      - name: Terraform Apply
        if: |
          (github.event_name == 'issue_comment' && startsWith(github.event.comment.body, '/apply')) ||
          (github.event_name == 'push' && github.ref == 'refs/heads/test')
        run: terraform apply -auto-approve tfplan | tee apply.log

      # ğŸ§© Step 6: Post Apply Result to PR
      - name: Post Apply Result
        if: |
          (github.event_name == 'issue_comment' && startsWith(github.event.comment.body, '/apply')) ||
          (github.event_name == 'push' && github.ref == 'refs/heads/test')
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GH_PAT }}
          script: |
            const fs = require('fs');
            const applyLog = 'apply.log';
            const prNumber = process.env.PR_NUMBER;

            if (!fs.existsSync(applyLog)) {
              console.log("âš ï¸ No apply.log found â€” skipping comment.");
            } else if (!prNumber) {
              console.log("âš ï¸ No PR number found â€” skipping comment.");
            } else {
              const apply = fs.readFileSync(applyLog, 'utf8').slice(0, 65000);
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: parseInt(prNumber, 10),
                body: `ğŸš€ **Terraform Apply Result:**\n\`\`\`\n${apply}\n\`\`\`\nâœ… Deployment completed successfully!`
              });
            }
        env:
          PR_NUMBER: ${{ steps.find_pr.outputs.pr_number }}
