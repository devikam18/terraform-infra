name: Terraform Automation

on:
  push:
    branches:
      - test  # ðŸ‘ˆ Change to your branch

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  terraform:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.6.6

      - name: Check if PR exists
        id: find_pr
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GTHUB_TOKEN }}
          script: |
            const prs = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              head: `${context.repo.owner}:test`,
              state: 'open'
            });
            if (prs.data.length > 0) {
              core.setOutput("pr_number", prs.data[0].number);
            } else {
              core.setOutput("pr_number", "");
            }

      - name: Create Pull Request if not exists
        if: steps.find_pr.outputs.pr_number == ''
        id: create_pr
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GTHUB_TOKEN }}
          branch: test
          base: main
          title: "Terraform Changes"
          body: "Auto-created PR for Terraform changes"

      - name: Terraform Init
        run: terraform init

      - name: Terraform Validate
        run: terraform validate

      - name: Terraform Plan
        run: terraform plan -no-color | tee plan.log

      - name: Post Plan Result to PR
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GTHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const plan = fs.readFileSync('plan.log', 'utf8').slice(0, 65000);
            const pr_number = "${{ steps.find_pr.outputs.pr_number || steps.create_pr.outputs.pull-request-number }}";
            if (!pr_number) {
              core.setFailed("No PR found or created");
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: pr_number,
                body: `ðŸª„ **Terraform Plan Result:**\n\`\`\`\n${plan}\n\`\`\`\nðŸ’¬ Comment **/apply** to deploy these changes.`
              });
            }

      # Uncomment below if you want auto apply right after plan
      # - name: Terraform Apply
      #   run: terraform apply -auto-approve
