name: Terraform Automation (auto-PR updated -> main)

on:
  push:
    branches:
      - updated
  issue_comment:
    types: [created]

permissions:
  contents: write
  pull-requests: write
  id-token: write

env:
  AWS_REGION: ap-south-2

jobs:
  terraform:
    name: Terraform CI / PR / Sentinel / tfsec
    runs-on: ubuntu-latest

    if: |
      github.event_name == 'push' ||
      (github.event_name == 'issue_comment' &&
       github.event.issue.pull_request != null &&
       (startsWith(github.event.comment.body, '/plan') ||
        startsWith(github.event.comment.body, '/apply')))

    env:
      AWS_REGION: ap-south-2
      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
      TF_CLOUD_TOKEN_app_terraform_io: ${{ secrets.TF_API_TOKEN }}

    steps:
      # ----------------------------------------------------------
      # 1. Checkout code
      # ----------------------------------------------------------
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # ----------------------------------------------------------
      # 2. Auto-create or update PR (updated -> main)
      # ----------------------------------------------------------
      - name: Create PR updated â†’ main
        if: github.event_name == 'push'
        uses: repo-sync/pull-request@v2
        with:
          source_branch: "updated"
          destination_branch: "main"
          github_token: ${{ secrets.GH_PAT }}
          pr_title: "ðŸª„ Terraform Infra Changes (auto)"
          pr_body: "Automated PR from updated â†’ main triggered by GitHub Actions."
          pr_draft: false

      # ----------------------------------------------------------
      # 3. Find PR number
      # ----------------------------------------------------------
      - name: Find PR number
        id: find_pr
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GH_PAT }}
          script: |
            const prs = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              head: `${context.repo.owner}:updated`,
              state: "open"
            });
            if (prs.data.length > 0) {
              core.setOutput("pr_number", prs.data[0].number);
            }

      # ----------------------------------------------------------
      # 4. Setup Terraform
      # ----------------------------------------------------------
      - uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.9.5

      # ----------------------------------------------------------
      # 5. Terraform Cloud Login
      # ----------------------------------------------------------
      - name: Terraform Cloud Login
        working-directory: ./terraform-infra
        run: terraform login -no-browser

      # ----------------------------------------------------------
      # 6. Terraform Init & Validate
      # ----------------------------------------------------------
      - name: Terraform Init
        working-directory: ./terraform-infra
        run: terraform init -input=false

      - name: Terraform Validate
        working-directory: ./terraform-infra
        run: terraform validate

      # ----------------------------------------------------------
      # 7. tfsec scan (correct version)
      # ----------------------------------------------------------
      - name: Install tfsec
        run: |
          curl -s https://raw.githubusercontent.com/aquasecurity/tfsec/master/scripts/install.sh | bash

      - name: Run tfsec scan
        run: |
          tfsec terraform-infra/ --no-color | tee tfsec.log

      - name: tfsec PR Comment
        if: steps.find_pr.outputs.pr_number != ''
        uses: aquasecurity/tfsec-pr-commenter-action@v1.0.3
        with:
          github_token: ${{ secrets.GH_PAT }}

      # ----------------------------------------------------------
      # 8. Terraform Plan (Sentinel enforced in Cloud)
      # ----------------------------------------------------------
      - name: Terraform Plan
        working-directory: ./terraform-infra
        run: terraform plan -no-color -out=tfplan | tee plan.log

      - uses: actions/upload-artifact@v4
        with:
          name: terraform-plan
          path: terraform-infra/tfplan

      - name: Post Plan to PR
        if: steps.find_pr.outputs.pr_number != ''
        uses: actions/github-script@v7
        env:
          PR_NUMBER: ${{ steps.find_pr.outputs.pr_number }}
        with:
          github-token: ${{ secrets.GH_PAT }}
          script: |
            const fs = require('fs');
            const log = fs.readFileSync('terraform-infra/plan.log','utf8').slice(0,65000);
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: parseInt(process.env.PR_NUMBER),
              body: `ðŸ› ï¸ **Terraform Plan Output**\n\`\`\`\n${log}\n\`\`\``
            });

      # ----------------------------------------------------------
      # 9. Require PR Approval Before /apply
      # ----------------------------------------------------------
      - name: Require PR Approval
        if: github.event_name == 'issue_comment' && startsWith(github.event.comment.body, '/apply')
        id: approvalCheck
        uses: actions/github-script@v7
        env:
          PR: ${{ steps.find_pr.outputs.pr_number }}
        with:
          github-token: ${{ secrets.GH_PAT }}
          script: |
            const reviews = await github.rest.pulls.listReviews({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: process.env.PR
            });
            const approvals = reviews.data.filter(r => r.state === 'APPROVED');
            if (approvals.length < 1)
              core.setFailed("âŒ No PR approval found. Please approve the PR before running /apply.");

      # ----------------------------------------------------------
      # 10. Terraform Apply (only after approval)
      # ----------------------------------------------------------
      - uses: actions/download-artifact@v4
        if: github.event_name == 'issue_comment' && startsWith(github.event.comment.body, '/apply')
        with:
          name: terraform-plan
          path: terraform-infra/

      - name: Terraform Apply
        if: github.event_name == 'issue_comment' && startsWith(github.event.comment.body, '/apply')
        working-directory: ./terraform-infra
        run: terraform apply -auto-approve tfplan | tee apply.log

      - name: Post Apply Result
        if: github.event_name == 'issue_comment' && startsWith(github.event.comment.body, '/apply')
        uses: actions/github-script@v7
        env:
          PR: ${{ steps.find_pr.outputs.pr_number }}
        with:
          github-token: ${{ secrets.GH_PAT }}
          script: |
            const fs = require('fs');
            const log = fs.readFileSync('terraform-infra/apply.log','utf8').slice(0,65000);
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: parseInt(process.env.PR),
              body: `ðŸš€ **Terraform Apply Completed**\n\`\`\`\n${log}\n\`\`\``
            })
