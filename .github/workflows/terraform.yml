name: Terraform Auto Plan & Apply

on:
  push:
    branches:
      - test
  issue_comment:
    types: [created]

permissions:
  contents: write
  pull-requests: write

jobs:
  terraform:
    runs-on: ubuntu-latest
    env:
      AWS_REGION: ap-south-2
      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.7.4

      - name: Terraform Init
        run: terraform init

      - name: Terraform Plan
        run: terraform plan -out=tfplan.out

      - name: Create or update Pull Request automatically
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          branch: terraform-auto-update
          base: main
          title: "ðŸª„ Terraform Infrastructure Changes"
          body: |
            This PR contains automated Terraform plan and apply steps.
            Comment `/plan` to preview or `/apply` to deploy.
          commit-message: "chore: terraform auto update"
          delete-branch: false
          branch-suffix: short-sha    # âœ… valid value
          labels: terraform, automation
          assignees: devikam18
          committer: github-actions[bot] <41898282+github-actions[bot]@users.noreply.github.com>
          author: devikam18 <233266106+devikam18@users.noreply.github.com>
          draft: false

  comment-trigger:
    runs-on: ubuntu-latest
    permissions:
      issues: write
      pull-requests: write
      contents: write
    if: github.event.issue.pull_request != null
    steps:
      - name: Check comment command
        id: check
        run: |
          comment="${{ github.event.comment.body }}"
          if [[ "$comment" == "/plan" ]]; then
            echo "command=plan" >> $GITHUB_OUTPUT
          elif [[ "$comment" == "/apply" ]]; then
            echo "command=apply" >> $GITHUB_OUTPUT
          else
            echo "command=none" >> $GITHUB_OUTPUT
          fi

      - name: Checkout repository
        if: steps.check.outputs.command != 'none'
        uses: actions/checkout@v4

      - name: Setup Terraform
        if: steps.check.outputs.command != 'none'
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.7.4

      - name: Terraform Init
        if: steps.check.outputs.command != 'none'
        run: terraform init

      - name: Terraform Plan
        if: steps.check.outputs.command == 'plan'
        run: terraform plan -no-color | tee plan_output.txt

      - name: Post Plan Output to PR
        if: steps.check.outputs.command == 'plan'
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          recreate: true
          path: plan_output.txt

      - name: Terraform Apply
        if: steps.check.outputs.command == 'apply'
        run: terraform apply -auto-approve -no-color | tee apply_output.txt

      - name: Post Apply Output to PR
        if: steps.check.outputs.command == 'apply'
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          recreate: true
          path: apply_output.txt
